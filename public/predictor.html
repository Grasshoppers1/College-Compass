<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College-Compass | Predictor</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@200;300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta2/css/v4-shims.min.css">
    <link rel="icon" href="images/logo.png" type="image/x-icon">
</head>
<body>
        
        
    
        <div class="predictor">
            
            <nav>
                <a href="index.html"><img src="images/Indeximage.png"></a>
                <div class="nav-links">
                 <ul>
                     <li><a href="index.html">Home</a></li>
                     <li><a href="index.html#Branch"> Branches</a></li>
                     <li><a href="index.html#predictor">  Finder</a></li>
                     <li><a href="contact.html"> Contact</a></li>
                    
                        
                        
                 </ul>
     
                 <!-- search icon -->
      </div>

      
            </nav>
   
       <h1>Finder</h1>
       <div class="main">
        <form id="predictorForm">
            <h2 class="title">Personal Details</h2>
            <div id="name">
                <h2 class="name">Name</h2>
                <input class="firstname" type="text" name="first_name" required><br>
                <label class="firstlabel">First Name*</label>
 
                <input class="lastname" type="text" name="last_name" required><br>
                <label class="lastlabel">Last Name*</label>
 
                <h2 id="gender">Gender*</h2>
                <label class="radio">
                    <input class="radio-one" type="radio" name="gender" value="Gender-Neutral" required>
                    Male
                </label>
                <label class="radio">
                    <input class="radio-two" type="radio" name="gender" value="Female-only (including Supernumerary)">
                    Female
                </label>
                  
                <h2 class="name">Email*</h2>
                <input class="email" type="email" name="email" required>

                <!-- <h2 class="name">Preferred Branch*</h2> -->
                <h2 class="name preferred-branch">Preferred Branch*</h2>

                <select class="option" name="branch" required>

                    <option disabled="disabled" selected="selected">--Choose Option--</option>
                    <option>ALL</option>
                    <option>Computer Science and Engineering </option>
                    <option>Electrical Engineering</option>
                    <option>Electronics and Telecommunication</option>
                    <option>Electronics and Communication Engineering</option>
                    <option>Artificial Intelligence</option>
                    <option>Civil Engineering</option>
                    <option>Engineering Physics</option>
                    <option>Mechanical Engineering</option>
                    <option>Materials Science and Metallurgical Engineering</option>
                    <option>Mechatronics Engineering</option>
                    <option>Chemical Engineering</option>
                    <option>Biosciences and Bioengineering</option>
                    <option>Pharmaceutical Engineering & Technology</option>
                    <option>Mining Engineering</option>
                    <option>Mathematics and Computing</option>
                    <option>Aerospace Engineering</option>
                    <option>BS in Mathematics</option>
                    <option>Chemistry</option>
                    <option>Economics</option>
                    <option>Biotechnology and Biochemical Engineering</option>
                    <option>Architecture</option>
                    <option>Agricultural and Food Engineering</option>
                    <option>Space Sciences and Engineering</option>
                    <option>Earth Sciences</option>
                    <option>Industrial Chemistry</option>
                    <option>Engineering Science</option>
                    <option>Computational Engineering</option>
                    


                </select>

                <h2 class="name">Category*</h2>
                    <select class="option" name="category" required>
                        <option disabled="disabled" selected="selected">--Choose Category--</option>
                        <option>OPEN</option>
                        <option>OBC-NCL</option>
                        <option>OBC-NCL (PwD)</option>
                        <option>OPEN (PwD)</option>
                        <option>SC</option>
                        <option>ST</option>
                        <option>EWS</option>
                    </select>
                    <p class="rank-info">Opening/Closing Ranks for Open Seats represent CRL. Opening/Closing Ranks for EWS, OBC-NCL, SC and ST Seats represent respective Category Ranks. Opening/Closing Ranks for PwD Seats represent PwD Ranks within Respective Categories.</p>
 
                <h2 class="title">Academic Details</h2>
                
                <h2 class="name">JEE Rank*</h2>
                <input class="ssc" type="number" name="jee_rank" required>
                
                <button type="button" class="hero-btn predict" onclick="submitForm()">See Results</button> 
            </div>
        </form>
        <div id="result"></div>
    </div>
   </div>
   <div id="limitModal" class="modal">
    <div class="modal-content">
        <h2>Session Limit Exceeded</h2>
        <p>Please log in to continue searching.</p>
        <button id="loginButton" onclick="window.location.href='login.html'">Login</button>
    </div>
</div>

<!-- Modal Background -->
<div id="modalBackground" class="modal-background"></div>
<section class="footer">
    <div class="container">
        <div class="row">
            <div class="col">
                <img src="images/Indeximage.png" class="footer-logo" >
               <p>A one-stop solution for students that includes
                preferences, minority and simultaneously predicts a suitable college
                   </p>
             </div>
             <div class="col-md-3">
                <h4>Group Members</h4>
                <p>Ayush Kumar Goyal</p>
                <p>  Tanmay Gupta</p>
                <p>  Parth Gupta</p>
                <p>  </p>
             </div>
             <div class="col-md-3">
                 <ul>
                <h4>Branches</h4>
                <li><a href="comps.html"><p>Computer Engineering</p></a></li>
                <li><a href="IT.html"><p>Information Technology</p></a></li>
                <li><a href="extc.html"><p>Electronics And Telecommunication</p></a></li>
                     <li><a href="electronics.html"> <p>Electronics  Engineering</p></a></li>  
                     <li><a href="AI.html"><p>Artificial-intelligence</p></a></li>
                              <li><a href="civil.html"><p>Civil Engineering</p></a></li>
                                  
                                     
            </ul>
            </div>
             <div class="col-md-3">
                 <ul>
                <h4>Other</h4>
                <li><a href="predictor.html"><p>Finder</p></a></li>
                    <li><a href="about.html"><p>About Us</p></a></li>
                </ul>
             </div>
             <div class="col-md-3">
                <h4>Contact Us</h4>
                <p><i class="fab fa-instagram"></i>@collegecompassedu</p>
                <p><i class="fab fa-google-plus"></i>contact.collegecompassedu@gmail.com</p>
             </div>

        </div> <hr>
        <br class="copyright"><br>Made by Students</br>
            <br> Made for students </br>
            </p>
    </div>

</section>

   <script>
     let latitude = null;
       let longitude = null;
       let locationDenied = false;

       // JavaScript for User Initial Box
document.addEventListener("DOMContentLoaded", () => {
  const userBox = document.getElementById("user-box");

  // Simulate logged-in user data (replace this with your login mechanism)
  const userName = localStorage.getItem("userName") || "John Doe";

  // Extract the first letter from the user's name
  const userInitial = userName.trim().charAt(0).toUpperCase();

  // Set the initial inside the box
  userBox.textContent = userInitial;

  // Add a tooltip with the full name
  userBox.setAttribute("title", `Logged in as: ${userName}`);
});

// Simulating login for demonstration purposes
function simulateLogin(name) {
  localStorage.setItem("userName", name);
}

       
      
        window.onload = function () {
            const user = localStorage.getItem('user');
    // Check if search count exists in localStorage
    if (localStorage.getItem('searchCount') === null) {
        localStorage.setItem('searchCount', '0'); // Initialize searchCount to 0 for new users
    }
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        latitude = position.coords.latitude;
                        longitude = position.coords.longitude;
                        console.log('Latitude:', latitude, 'Longitude:', longitude);
                    },
                    (error) => {
                        console.warn('Error fetching location:', error.message);
                        alert('Location permission denied. Predictions might not be accurate.');
                        locationDenied = true;
                        
                    }
                );
            } else {
                alert('Geolocation is not supported by your browser.');
                locationDenied = true;
                
            }
        };

        
    let a=false;
   
       async function submitForm() {
       

           const form = document.getElementById('predictorForm');
           const formData = new FormData(form);
           const branch = formData.get('branch') === 'ALL' ? '' : formData.get('branch'); // Send empty string for "ALL"
           const category = formData.get('category'); // Get the selected category
           
           if(branch==''){a=true;}
           else{
            a=false;
           }
            const data = {
            first_name: formData.get('first_name'),
            last_name: formData.get('last_name'),
            gender: formData.get('gender'),
            email: formData.get('email'),
            phone: formData.get('phone'),
            branch: branch,
            category: category,
            jee_rank: formData.get('jee_rank'),
            latitude: locationDenied ? undefined : latitude,  // Include latitude only if permission granted
            longitude: locationDenied ? undefined : longitude,  // Include longitude only if permission granted
            locationPermissionGranted: !locationDenied  // Send true if permission is granted
           };

           console.log('Sending data:', data); // Debugging log

           
    const user = localStorage.getItem('user');
    const isLoggedIn = user !== null;

    if (!isLoggedIn) {
        let searchCount = localStorage.getItem('searchCount') || 0;
        searchCount = parseInt(searchCount) + 1;

        if (searchCount > 3) {
            alert('You have exceeded the limit. Please log in to continue.');
           showLoginPrompt(); // Redirect to login page
            return;
        }

        localStorage.setItem('searchCount', searchCount);
    }
           

           try {
               const response = await fetch('http://localhost:5000/predict', {
                   method: 'POST',
                   headers: {
                       'Content-Type': 'application/json',
                   },
                   body: JSON.stringify(data),
                  // credentials: 'include' // Ensure session cookie is included in the request
               });

               if (response.ok) {
                const responseData = await response.json();
                console.log('Response Data:', responseData); // Log the entire response
                colleges = Array.isArray(responseData) ? responseData : responseData.colleges;

                if (colleges) {
                    console.log('Colleges received:', colleges);
                    displayResults(colleges);
                } else {
                    console.error('Colleges data is missing or undefined');
                    document.getElementById('result').innerHTML = '<p>No colleges data received.</p>';
                }
console.log('Colleges received:', colleges);
                        if(colleges){
                   displayResults(colleges);
                        }
                        else{
                            console.error('Colleges data is missing or undefined');
                        }
               }else if (response.status === 403) { // Assuming 401 is for unauthorized or login-required
                showLoginPrompt();  // Show the login prompt if session limit exceeded 
                } else {
                   console.error('Failed to fetch colleges:', response.statusText);
                   document.getElementById('result').innerHTML = `<p>Failed to fetch colleges: ${response.status} ${response.statusText}</p>`;
               }
           } catch (error) {
               console.error('Error:', error);
               document.getElementById('result').innerHTML = '<p>An error occurred. Please try again.</p>';
              
           }
       }

    //    function displayResults(colleges) {
    //        const resultDiv = document.getElementById('result');
    //        resultDiv.innerHTML = '';

    //        if (colleges.length === 0) {
    //            resultDiv.innerHTML = '<p>No colleges found for your criteria.</p>';
    //            return;
    //        }

    //        const list = document.createElement('ul');
    //        colleges.forEach(college => {
    //            const listItem = document.createElement('li');
    //            if(a==false){
    //            listItem.textContent = `${college['Institute Name ']} - Closing Rank: ${college['CLOSE RANK']} - NIRF RANK: ${college['NIRF_RANK']}`; 
    //            }
    //            else{
    //             listItem.textContent = `${college['Institute Name ']} - ${college['Branch ']} -Closing Rank: ${college['CLOSE RANK']} - NIRF RANK: ${college['NIRF_RANK']}`;
                
    //            }
    //            list.appendChild(listItem);
    //        });

    //        resultDiv.appendChild(list);
    //    }

    function showLoginPrompt() {
        const modal = document.getElementById('limitModal');
        const background = document.getElementById('modalBackground');
        
        modal.style.display = 'block';
        background.style.display = 'block';
    }

    // Close the modal when clicked outside the modal content
    document.getElementById('modalBackground').addEventListener('click', () => {
        const modal = document.getElementById('limitModal');
        const background = document.getElementById('modalBackground');
        
        modal.style.display = 'none';
        background.style.display = 'none';
    });

    let currentPage = 1;
const rowsPerPage = 15;

function displayResults(colleges) {
    const resultDiv = document.getElementById('result');
    resultDiv.innerHTML = '';

    if (colleges.length === 0) {
        resultDiv.innerHTML = '<p>No colleges found for your criteria.</p>';
        return;
    }

    // Calculate the starting and ending index for the current page
    const startIndex = (currentPage - 1) * rowsPerPage;
    const endIndex = startIndex + rowsPerPage;
    const paginatedColleges = colleges.slice(startIndex, endIndex);

    // Create table element
    const table = document.createElement('table');
    table.classList.add('result-table');

    // Create table headers
    const headerRow = document.createElement('tr');
    const headers = a 
        ? ['S.No', 'Institute Name', 'Branch', 'Closing Rank', 'NIRF Rank,Distance (km)']
        : ['S.No', 'Institute Name','Branch', 'Closing Rank', 'NIRF Rank','Distance (km)'];

    headers.forEach(headerText => {
        const th = document.createElement('th');
        th.textContent = headerText;
        headerRow.appendChild(th);
    });
    table.appendChild(headerRow);

    // Add paginated college data rows
    paginatedColleges.forEach((college, index) => {
        const row = document.createElement('tr');

        // Add the S.No column
        const snoTd = document.createElement('td');
        snoTd.textContent = startIndex + index + 1; // Calculate serial number based on page
        row.appendChild(snoTd);

    //     const nameTd = document.createElement('td');
    // nameTd.innerHTML = `<a href="http://localhost:5000/details.html/${college._id}" class="clickable-name" target="_blank">${college['Institute Name ']}</a>`;
    // row.appendChild(nameTd);

    const nameTd = document.createElement('td');

// Check if the necessary data is available
console.log(college);  // Check if college._id and college['Institute Name '] are correct

nameTd.innerHTML = `
    <a href="http://127.0.0.1:5500/COLLEGE-COMPASS/public/details.html?name=${encodeURIComponent(college['Institute Name '])}" 
       class="clickable-name" target="_blank">
       ${college['Institute Name ']}
    </a>`;

row.appendChild(nameTd);

    

        const columns = a 
            ? [college['Branch '], college['CLOSE RANK'], college['NIRF_RANK'],college.distance ? college.distance.toFixed(2) : 'N/A']
            : [college['Branch '],college['CLOSE RANK'], college['NIRF_RANK'],college.distance ? college.distance.toFixed(2) : 'N/A'];
        
        // Add each data cell
        columns.forEach(columnData => {
            const td = document.createElement('td');
            td.textContent = columnData;
            row.appendChild(td);
        });

        table.appendChild(row);
    });

    resultDiv.appendChild(table);

    // Add pagination controls
    const paginationDiv = document.createElement('div');
    paginationDiv.classList.add('pagination');

    if (currentPage > 1) {
        const prevButton = document.createElement('button');
        prevButton.textContent = 'Previous';
        prevButton.addEventListener('click', () => {
            currentPage--;
            displayResults(colleges);
        });
        paginationDiv.appendChild(prevButton);
    }

    if (endIndex < colleges.length) {
        const nextButton = document.createElement('button');
        nextButton.textContent = 'Next';
        nextButton.addEventListener('click', () => {
            currentPage++;
            displayResults(colleges);
        });
        paginationDiv.appendChild(nextButton);
    }

    resultDiv.appendChild(paginationDiv);
}
function showLoginPrompt() {
           document.getElementById('limitModal').style.display = 'block';
           document.getElementById('modalBackground').style.display = 'block';
       }

       document.getElementById('modalBackground').addEventListener('click', () => {
           document.getElementById('limitModal').style.display = 'none';
           document.getElementById('modalBackground').style.display = 'none';
       });

   </script>
</body>
</html>
